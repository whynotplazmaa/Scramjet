<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Games</title>
<style>
:root{--bg:#f3e5f5;--muted:#666}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#f3e5f5 0%, #fff 100%);color:#000}
.header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px}
.title{font-size:18px;font-weight:700;color:#000}
.container{padding:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.card{background:#fff;border-radius:10px;padding:10px;cursor:pointer;border:1px solid rgba(0,0,0,0.06);color:#000}
.thumb{height:120px;border-radius:8px;overflow:hidden;background:#f5f5f5;display:flex;align-items:center;justify-content:center}
.thumb img{width:100%;height:100%;object-fit:cover}
.name{margin-top:8px;font-weight:700;color:#000}
.meta{font-size:12px;color:var(--muted)}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:linear-gradient(45deg,#7b1fa2,#ec407a);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
.viewer{position:fixed;inset:0;background:#fff;display:flex;flex-direction:column}
.viewer .bar{padding:10px;display:flex;justify-content:space-between;gap:8px;align-items:center;background:#fff;border-bottom:1px solid rgba(0,0,0,0.06)}
.viewer iframe{flex:1;border:0;background:#000;}
.small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
	<div class="header">
		<div class="title">Games</div>
		<div class="controls">
			<button class="btn" id="back-btn" style="display:none">Back to list</button>
			<span class="small">Powered by proxy engine (choose in main page)</span>
		</div>
	</div>
	<div class="container" id="list-root"></div>

<script>
(function(){
	const qs = new URLSearchParams(location.search);
	const enc = qs.get('u');
	const listRoot = document.getElementById('list-root');

	function getStoredEngine(){ return localStorage.getItem('proxy-engine') || 'scramjet'; }
	function getStoredPath(){ return localStorage.getItem('proxy-path') || '/scram/'; }
	function getProxyUrl(target){
		const engine = getStoredEngine();
		const basePath = (localStorage.getItem('proxy-path') || (engine==='scramjet' ? '/scram/' : '/ultraviolet/')).trim();
		const path = basePath.startsWith('/') ? basePath : '/' + basePath;
		return location.origin + path + btoa(target);
	}

	function renderList(list){
		listRoot.innerHTML = '';
		const grid = document.createElement('div'); grid.className = 'grid';
		for(const g of list){
			const c = document.createElement('div'); c.className = 'card';
			const t = document.createElement('div'); t.className = 'thumb';
			const img = document.createElement('img'); img.alt = g.title||g.url;
			img.src = g.thumb || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="220"><rect width="100%" height="100%" fill="%23071b26"/></svg>';
			t.appendChild(img);
			const name = document.createElement('div'); name.className='name'; name.textContent = g.title||g.url;
			const meta = document.createElement('div'); meta.className='meta'; meta.textContent = g.url;
			c.appendChild(t); c.appendChild(name); c.appendChild(meta);
			c.onclick = ()=> {
				// navigate to the viewer (same page) with encoded url
				const u = encodeURIComponent(btoa(g.url));
				location.href = location.origin + '/games.html?u=' + u;
			};
			grid.appendChild(c);
		}
		listRoot.appendChild(grid);
	}

	// if query param provided -> show viewer
	if(enc){
		let target = null;
		try { target = atob(decodeURIComponent(enc)); } catch(e) {
			// maybe stored fallback
			const sel = localStorage.getItem('selected-game');
			if(sel) try{ target = JSON.parse(sel).url }catch(e){}
		}
		if(!target){
			listRoot.innerHTML = '<div class="small" style="padding:18px">Invalid game parameter.</div>';
		} else {
			document.querySelector('#back-btn').style.display = '';
			showViewer(target);
		}
	} else {
		// show cached list from localStorage
		const cached = localStorage.getItem('crazygames-all');
		if(cached){
			try{
				const list = JSON.parse(cached);
				renderList(list);
			}catch(e){
				listRoot.innerHTML = '<div class="small" style="padding:18px">Failed to parse cached list.</div>';
			}
		} else {
			listRoot.innerHTML = '<div class="small" style="padding:18px">No game list cached. Open the main page Hub and click Refresh to crawl CrazyGames first.</div>';
		}
	}

	document.getElementById('back-btn').addEventListener('click', ()=> {
		// go back to list view
		history.replaceState(null,'', location.pathname);
		location.reload();
	});

	async function showViewer(target){
		// build proxied URL using selected engine/path
		const prox = getProxyUrl(target);
		// create viewer DOM
		listRoot.innerHTML = '';
		const viewer = document.createElement('div'); viewer.className = 'viewer';
		const bar = document.createElement('div'); bar.className = 'bar';
		const left = document.createElement('div'); left.style.display='flex'; left.style.gap='8px';
		const title = document.createElement('div'); title.textContent = target;
		const fsBtn = document.createElement('button'); fsBtn.className='btn'; fsBtn.textContent='Fullscreen';
		const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close';
		left.appendChild(title);
		bar.appendChild(left);
		const right = document.createElement('div');
		right.appendChild(fsBtn); right.appendChild(closeBtn);
		bar.appendChild(right);
		const iframe = document.createElement('iframe');
		iframe.allow = 'fullscreen; autoplay; encrypted-media; picture-in-picture';
		iframe.src = prox;
		viewer.appendChild(bar); viewer.appendChild(iframe);
		listRoot.appendChild(viewer);

		// attempt to fetch proxied doc and locate an inner game iframe to use directly (best-effort)
		try {
			const res = await fetch(prox);
			if(res.ok){
				const txt = await res.text();
				const doc = new DOMParser().parseFromString(txt,'text/html');
				const innerFrame = doc.querySelector('iframe') || doc.querySelector('div[class*="game"] iframe') || doc.querySelector('#game iframe');
				if(innerFrame){
					let inner = innerFrame.getAttribute('src') || innerFrame.getAttribute('data-src') || innerFrame.src || null;
					if(inner){
						if(!inner.startsWith('http')){
							try{ inner = new URL(inner, target).href } catch(e){}
						}
						if(inner){
							iframe.src = inner;
						}
					}
				}
			}
		} catch(e){}
		// controls
		fsBtn.addEventListener('click', async ()=> {
			try{ if(iframe.requestFullscreen) await iframe.requestFullscreen(); else if(document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen(); }catch(e){}
		});
		closeBtn.addEventListener('click', ()=> { history.replaceState(null,'', location.pathname); location.reload(); });
	}
})();
</script>
</body>
</html>
